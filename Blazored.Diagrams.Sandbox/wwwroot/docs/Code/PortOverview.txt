@page "/port-overview"

<MudGrid Spacing="2" Justify="Justify.Center" Style="height:100%; width: 100%; margin: 0;">

    <!-- LEFT PANEL: Documentation -->
    <MudItem xs="12" sm="4" Style="height: 100%; overflow-y: auto;">
        <MudPaper Class="pa-4 mud-height-full">
            <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true">Port Overview</MudText>

            <MudExpansionPanels MultiExpansion="false">

                <!-- Panel 1: What is a Port? -->
                <MudExpansionPanel Text="What is a Port?" Expanded="true">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        Ports are the connection points on nodes and groups. They are the models (defined in <code>Port.cs</code>)
                        that links connect to.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Any model that implements <code>IPortContainer</code> (like <code>Node</code> or
                        <code>Group</code>) can have ports.
                    </MudText>
                    <MudText Typo="Typo.body2">
                        The default visual component for a port is <code>DefaultPortComponent.razor</code>, which
                        renders a simple circle.
                    </MudText>
                </MudExpansionPanel>

                <!-- Panel 2: Port Positioning -->
                <MudExpansionPanel Text="Port Positioning" Expanded="false">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        A port's position is almost always calculated automatically based on its parent node/group. This
                        logic is controlled by two key enums:
                    </MudText>
                    <MudAlert Severity="Severity.Info" Class="mb-3">
                        The exact positioning logic is defined inside the <code>PortContainer.razor</code> component's
                        <code>CalculatePosition()</code> method.
                    </MudAlert>

                    <MudText Typo="Typo.h6" GutterBottom="true">1. PortAlignment</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        The enum <code>PortAlignment.cs</code> determines which <strong>edge</strong> of the parent the
                        port will attach to.
                    </MudText>

                    <MudText Typo="Typo.h6" GutterBottom="true" Class="mt-3">2. PortJustification</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        The enum <code>PortJustification.cs</code> determines <strong>where along that edge</strong> the
                        port will be placed.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mt-2">
                        <strong>Note:</strong> <code>Start</code> and <code>End</code> are relative. For a
                        <strong>Left</strong> (vertical) edge, <code>Start</code> is the Top. For a <strong>Top</strong>
                        (horizontal) edge, <code>Start</code> is the Left.
                    </MudText>
                </MudExpansionPanel>

                <!-- Panel 3: Advanced Positioning (NEW) -->
                <MudExpansionPanel Text="Advanced Positioning" Expanded="false">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        For full control, you can bypass the alignment system or apply fine-grained offsets.
                    </MudText>

                    <MudText Typo="Typo.h6" GutterBottom="true" Class="mt-3">1. Custom Positioning</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Set <code>Alignment = PortAlignment.Custom</code> and override the
                        <code>CustomPositioning()</code> method in a custom port class. This gives you absolute position
                        control relative to the parent.
                    </MudText>
                    <CodeHighlighter Language="csharp" Code="@CustomPositioningCode"/>

                    <MudText Typo="Typo.h6" GutterBottom="true" Class="mt-3">2. Position Offsets</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Use the <code>OffSetX</code> and <code>OffsetY</code> properties (from <code>Port.cs</code>).
                        These values are added *after* the <code>PortAlignment</code> and <code>PortJustification</code>
                        are calculated, allowing you to "nudge" a port from its default spot.
                    </MudText>
                    <CodeHighlighter Language="csharp" Code="@OffsetCode"/>
                </MudExpansionPanel>

                <!-- Panel 4: Port Logic Overrides -->
                <MudExpansionPanel Text="Port Logic Overrides" Expanded="false">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        You can control linking behavior by overriding methods from <code>Port.Features.cs</code> in a
                        custom port model.
                    </MudText>

                    <MudText Typo="Typo.h6" GutterBottom="true" Class="mt-3">1. CanCreateLink()</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        This method determines if a user can start dragging a new link from this port. By default, it
                        returns <code>true</code>.
                    </MudText>
                    <CodeHighlighter Language="csharp" Code="@CanCreateLinkCode"/>

                    <MudText Typo="Typo.h6" GutterBottom="true" Class="mt-3">2. CanConnectTo(IPort port)</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        This method is called when a user tries to drop a link onto this port. It allows you to validate
                        the connection.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        The default logic prevents connecting a port to itself or to another port on the same parent.
                    </MudText>
                    <CodeHighlighter Language="csharp" Code="@CanConnectToCode"/>
                </MudExpansionPanel>


                <!-- Panel 5: How to Add Ports -->
                <MudExpansionPanel Text="How to Add Ports" Expanded="false">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        You can easily add ports to any <code>IPortContainer</code> using the
                        <code>DiagramService</code>.
                    </MudText>
                    <CodeHighlighter Language="csharp" Code="@AddPortCode"/>
                </MudExpansionPanel>

            </MudExpansionPanels>
        </MudPaper>
    </MudItem>

    <!-- RIGHT PANEL: Diagram -->
    <MudItem xs="12" sm="8" Style="height: 100%;">
        <MudPaper Class="mud-height-full" Elevation="4">
            <DiagramContainer DiagramService="Service"/>
        </MudPaper>
    </MudItem>

</MudGrid>

@code {
    [Inject] public IDiagramService Service { get; set; } = null!;

    private const string AddPortCode =
        @"// 1. Create a node
        var node = new Node();
        node.SetPosition(50, 50);
        Service.AddNode(node);
        
        // 2. Define a port
        var port = new Port 
        { 
            Alignment = PortAlignment.Right, 
            Justification = PortJustification.Center 
        };
        
        // 3. Add the port to the node
        Service.AddPortTo(node, port);";

    private const string CanCreateLinkCode =
        @"// Example: Only allow 1 outgoing link
        public override bool CanCreateLink()
        {
            // HasOutGoingLinks is a property from Port.cs
            return !this.HasOutGoingLinks;
        }";

    private const string CanConnectToCode =
        @"// Example: Only allow connections from CustomPort
        public override bool CanConnectTo(IPort port)
        {
            // 1. Run the base logic (prevents self-connection)
            bool baseCanConnect = base.CanConnectTo(port);
            if (!baseCanConnect)
                return false;
                
            // 2. Add custom logic: only accept CustomPort
            return port is CustomPort;
        }";

    private const string CustomPositioningCode =
        @"// 1. Define a custom port class
        public class CustomPositionPort : Port
        {
            // 2. Override CustomPositioning
            public override (int PositionX, int PositionY) CustomPositioning()
            {
                // Position port 25% down and 25% across the parent
                var x = Parent.PositionX + (Parent.Width / 4);
                var y = Parent.PositionY + (Parent.Height / 4);
                return (x, y);
            }
        }
        
        // 3. Use it in your diagram
        var customPort = new CustomPositionPort 
        { 
            Alignment = PortAlignment.Custom 
        };
        Service.AddPortTo(myNode, customPort);";

    private const string OffsetCode =
        @"// Get a port (e.g., Top Center)
        var port = new Port 
        { 
            Alignment = PortAlignment.Top, 
            Justification = PortJustification.Center 
        };
        
        // Nudge it 20px to the right
        port.OffSetX = 20;
        
        Service.AddPortTo(myNode, port);";


    // --- Diagram Initialization ---

    protected override Task OnInitializedAsync()
    {
        // 1. Create a large central node to host the ports
        var mainNode = new Node();
        mainNode.SetPosition(150, 100);
        mainNode.SetSize(400, 300);
        Service.AddNode(mainNode);

        // --- Add ports for every alignment/justification combo ---
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Left, Justification = PortJustification.Start });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Left, Justification = PortJustification.Center });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Left, Justification = PortJustification.End });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Right, Justification = PortJustification.Start });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Right, Justification = PortJustification.Center });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Right, Justification = PortJustification.End });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Top, Justification = PortJustification.Start });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Top, Justification = PortJustification.Center });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Top, Justification = PortJustification.End });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Bottom, Justification = PortJustification.Start });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Bottom, Justification = PortJustification.Center });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.Bottom, Justification = PortJustification.End });
        Service.AddPortTo(mainNode, new Port { Alignment = PortAlignment.CenterParent });


        // 2. Create a second node to link to
        var targetNode = new Node();
        targetNode.SetPosition(650, 225);
        Service.AddNode(targetNode);

        var targetPort = new Port { Alignment = PortAlignment.Left, Justification = PortJustification.Center };
        Service.AddPortTo(targetNode, targetPort);

        // 3. Add a link
        var sourcePort = mainNode.Ports.First(p => p.Alignment == PortAlignment.Right && p.Justification == PortJustification.Center);
        Service.AddLinkTo(sourcePort, targetPort, new LineLink());

        // 4. Add a third node to show advanced positioning
        var advancedNode = new Node();
        advancedNode.SetPosition(150, 450);
        advancedNode.SetSize(400, 150);
        Service.AddNode(advancedNode);

        // 4a. Add a custom positioned port
        var customPort = new CustomPositionPort { Alignment = PortAlignment.Custom };
        Service.AddPortTo(advancedNode, customPort);

        return base.OnInitializedAsync();
    }

}

