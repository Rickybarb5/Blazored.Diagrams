@page "/editor"
@using Blazored.Diagrams.Events
@using Blazored.Diagrams.Options.Behaviours
@implements IDisposable
<CascadingValue Value="Service">
    <MudToolBar Dense="true">
        <DiagramEditor OnDiagramLoaded="OnDiagramLoaded"></DiagramEditor>
       
    </MudToolBar>
    <div style="display:flex;flex-direction:row;width:100%; height:100%">
        <div style="display:flex;flex-direction:column;height:100%;width:20%">

            @if (selectedLink is not null)
            {
                <LinkEditor SelectedItem="@selectedLink"></LinkEditor>
            }
            @if (SelectedPort is not null)
            {
                <PortEditor Port="SelectedPort"></PortEditor>
            }
            @if (SelectedNode is not null)
            {
                <NodeEditor Node="SelectedNode"></NodeEditor>
            }
            @if (SelectedGroup is not null)
            {
                <GroupEditor Group="SelectedGroup"></GroupEditor>
            }
        </div>
        <DiagramContainer DiagramService="Service">
            <ZoomControls ></ZoomControls>
        </DiagramContainer>
    </div>
</CascadingValue>


@code {
    [Inject] public IDiagramService Service { get; set; } = null!;
    IPort? SelectedPort;
    ILink? selectedLink;
    INode? SelectedNode;
    IGroup? SelectedGroup;
    private List<IDisposable> _subscriptions= [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            GroupWithNodesAndPorts();
            Service.Behaviours.GetBehaviourOptions<SelectBehaviourOptions>().MultiSelectEnabled = true;
            _subscriptions =
            [
                Service.Events.SubscribeTo<PortClickedEvent>(OnPortClicked),
                Service.Events.SubscribeTo<LinkClickedEvent>(OnLinkClicked),
                Service.Events.SubscribeTo<NodeClickedEvent>(OnNodeClicked),
                Service.Events.SubscribeTo<GroupClickedEvent>(OnGroupClicked),
            ];
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private void OnNodeClicked(NodeClickedEvent e)
    {
        SelectedPort = null;
        selectedLink = null;
        SelectedGroup = null;
        SelectedNode = e.Model;
        StateHasChanged();
    }

    private void OnLinkClicked(LinkClickedEvent e)
    {
        selectedLink = e.Model;
        SelectedPort = null;
        SelectedNode = null;
        SelectedGroup = null;
        StateHasChanged();
    }

    private void OnPortClicked(PortClickedEvent e)
    {
        SelectedPort = e.Model;
        selectedLink = null;
        SelectedNode = null;
        SelectedGroup = null;
        StateHasChanged();
    }

    private void GroupWithNodesAndPorts()
    {
        var diagramNode1 = new Node();
        var diagramNode2 = new Node();
        Service.Add.Node(diagramNode1);
        Service.Add.PortTo(diagramNode1, new Port());
        Service.Add.Node(diagramNode2);

        var group1 = new Group();
        var group2 = new Group();
        group2.Padding = 50;
        var nestedGroup = new Group();
        nestedGroup.Padding = 25;
        var node1 = new Node();
        node1.SetPosition(100, 100);
        var node2 = new Node();
        node2.SetPosition(200, 200);
        var node3 = new Node();
        node3.SetPosition(300, 300);
        var node4 = new Node();
        node4.SetPosition(400, 400);
        var node5 = new Node();
        node5.SetPosition(500, 600);
        var node6 = new Node();
        node6.SetPosition(800, 800);
        var port1 = new Port();
        port1.Alignment = PortAlignment.Right;
        var port2 = new Port();
        port2.Alignment = PortAlignment.Left;
        var port3 = new Port();
        port3.Alignment = PortAlignment.Right;
        port3.Justification = PortJustification.Center;

        var port4 = new Port();
        port4.Alignment = PortAlignment.Left;
        port4.Justification = PortJustification.Center;

        Service.Add.Group(group1);
        Service.Add.Group(group2);
        Service.Add.NodeTo(group1, node1);
        Service.Add.NodeTo(group1, node2);
        Service.Add.NodeTo(group2, node3);
        Service.Add.NodeTo(group2, node4);
        Service.Add.NodeTo(nestedGroup, node5);
        Service.Add.NodeTo(nestedGroup, node6);
        Service.Add.AddGroupTo(group2, nestedGroup);
        Service.Add.PortTo(node1, port1);
        Service.Add.PortTo(node2, port2);
        Service.Add.PortTo(group1, port3);
        Service.Add.PortTo(group2, port4);
        
        StateHasChanged();
    }

    public void Dispose()
    {
        _subscriptions.DisposeAll();
    }

    private void OnGroupClicked(GroupClickedEvent e)
    {
        SelectedPort = null;
        selectedLink = null;
        SelectedNode = null;
        SelectedGroup = e.Model;
        StateHasChanged();
    }

    private void OnDiagramLoaded(string obj)
    {
        _subscriptions.DisposeAll();
        //TODO: fix this
        // Service.CreateFromJson<Diagram>(obj);
        _subscriptions =
        [
            Service.Events.SubscribeTo<PortClickedEvent>(OnPortClicked),
            Service.Events.SubscribeTo<LinkClickedEvent>(OnLinkClicked),
            Service.Events.SubscribeTo<NodeClickedEvent>(OnNodeClicked),
            Service.Events.SubscribeTo<GroupClickedEvent>(OnGroupClicked),
        ];
        StateHasChanged();
    }

}