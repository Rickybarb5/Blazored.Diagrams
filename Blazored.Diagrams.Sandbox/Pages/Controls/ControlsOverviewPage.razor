@page "/controls-overview"

<MudGrid Spacing="2" Justify="Justify.Center" Style="height:100%; width: 100%; margin: 0;">

    <!-- LEFT PANEL: Documentation -->
    <MudItem xs="12" sm="6" Style="height: 100%; overflow-y: auto;">
        <MudPaper Class="pa-4 mud-height-full">
            <MudText Typo="Typo.h5" Color="Color.Primary" GutterBottom="true">Diagram Controls</MudText>

            <MudExpansionPanels MultiExpansion="false">

                <!-- Panel 1: What are Controls? -->
                <MudExpansionPanel Text="What are Controls?" Expanded="true">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        Controls are custom Blazor components that you can place directly inside the <code>&lt;DiagramContainer&gt;</code> component.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        The <code>DiagramContainer</code> exposes a <code>ChildContent</code> (a Blazor <code>RenderFragment</code>) that allows you to render any arbitrary HTML or components *on top of* the diagram canvas.
                    </MudText>
                    <MudAlert Severity="Severity.Info" Class="mb-3">
                        Because these components are children of the <code>DiagramContainer</code>, they can receive the <code>IDiagramService</code> as a <code>[CascadingParameter]</code>. This gives them full access to the diagram's state and events.
                    </MudAlert>
                </MudExpansionPanel>

                <!-- Panel 2: How to Use Controls -->
                <MudExpansionPanel Text="How to Use Controls" Expanded="true">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        To add a control, simply declare it inside the <code>&lt;DiagramContainer&gt;</code> tags. The control will be rendered inside the container's main <code>div</code> element.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        You can use standard CSS (like <code>position: absolute</code>) to place your control at a specific location, such as the bottom-right or top-right corner.
                    </MudText>
                    <CodeHighlighter Language="cshtml" Code="@UsageCode"/>
                </MudExpansionPanel>

                <!-- Panel 3: Example: ZoomControls.razor -->
                <MudExpansionPanel Text="ZoomControls" Expanded="false">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        The <code>ZoomControls</code> component (shown bottom-right) provides buttons for zooming in, out, and resetting the view.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        It cascades the <code>IDiagramService</code> to access zoom levels/options and call methods like <code>Service.Diagram.SetZoom()</code>. CSS from <code>ZoomControls.razor.css</code> positions it absolutely.
                    </MudText>
                    <CodeHighlighter Language="cshtml" Code="@ZoomControlCode"/>
                </MudExpansionPanel>

                <!-- Panel 4: Example: MinimapControls.razor -->
                <MudExpansionPanel Text="MinimapControls" Expanded="false">
                    <MudText Typo="Typo.body1" Class="mb-2">
                        The <code>MinimapControls</code> component (shown top-right) renders a scaled-down SVG representation of the entire diagram.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        It iterates through all diagram models (Nodes, Groups, Links, Ports), calculates the overall bounds, and draws them within its own SVG viewport.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        It cascades the <code>IDiagramService</code> and subscribes to events (like model changes, pan, zoom) to keep the minimap synchronized.
                    </MudText>
                    <CodeHighlighter Language="cshtml" Code="@MinimapControlCode"/>
                </MudExpansionPanel>

            </MudExpansionPanels>
        </MudPaper>
    </MudItem>

    <!-- RIGHT PANEL: Diagram with Controls -->
    <MudItem xs="12" sm="6" Style="height: 100%;">
        <MudPaper Class="mud-height-full" Elevation="4" Style="position: relative;">
            <DiagramContainer DiagramService="Service">
                <ZoomControls/>
                <MinimapControls/>
            </DiagramContainer>
        </MudPaper>
    </MudItem>

</MudGrid>

@code {
    [Inject] public IDiagramService Service { get; set; } = null!;

    protected override Task OnInitializedAsync()
    {
        var node1 = new Node();
        node1.SetPosition(50, 50);
        Service.AddNode(node1);

        var node2 = new Node();
        node2.SetPosition(250, 150);
        Service.AddNode(node2);

        return base.OnInitializedAsync();
    }

// --- Code Snippets ---

    private const string UsageCode =
        @"<!-- In your .razor file -->

<DiagramContainer DiagramService=""MyDiagramService"">

    <!-- Add your custom control components here -->
    <ZoomControls />
    <MinimapControls />
    <MyOtherControl />

</DiagramContainer>";

    private const string ZoomControlCode =
        @"@using Blazored.Diagrams.Options.Behaviours
@using Blazored.Diagrams.Services.Diagrams
@implements IDisposable

<div class=""diagram-zoom-container"">
    <button @onclick=""ZoomIn"" disabled=""@IsZoomLimitReached(ZoomDirection.In)"">+</button>
    <div @onclick=""ResetZoom"">@($""{(Service.Diagram.Zoom * 100):0}%"")</div>
    <button @onclick=""ZoomOut"" disabled=""@IsZoomLimitReached(ZoomDirection.Out)"">&minus;</button>
</div>

@code {
    // 1. Cascade the service
    [CascadingParameter]
    public required IDiagramService Service { get; set; } = null!;
    
    // ... Parameters for styling ...
    private ZoomBehaviourOptions options = new();

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 2. Access diagram options
            options = Service.Behaviours.GetBehaviourOptions<ZoomBehaviourOptions>()!;
             // Subscribe to zoom changes to update display
            _redrawSubscription = Service.Events.SubscribeTo<Blazored.Diagrams.Events.DiagramZoomChangedEvent>(_ => InvokeAsync(StateHasChanged));
        }
        return base.OnAfterRenderAsync(firstRender);
    }

    private void ZoomIn()
    {
        // 3. Call service methods
        Service.Diagram.SetZoom(Service.Diagram.Zoom + options.ZoomStep);
    }
    // ... ZoomOut, ResetZoom ...

    private bool IsZoomLimitReached(ZoomDirection direction) { /* ... */ }
    
    // ... Dispose ...
}
";

    private const string MinimapControlCode =
        @"@using System.Globalization
@using Blazored.Diagrams.Services.Diagrams
@implements IDisposable

<div class=""minimap-container @Class"" style=""@Style"">
    <svg class=""minimap-svg"" width=""@Width"" height=""@Height"" viewBox=""@ViewBoxString"">
        
        @* Iterate and render diagram elements *@
        @foreach (var node in Service.Diagram.AllNodes) { /* ... <rect> ... */ }
        @foreach (var link in Service.Diagram.AllLinks) { /* ... <line> ... */ }
        
        @* Render Current Viewport rectangle *@
        <rect class=""minimap-current-view"" x=""@_viewportRectX"" ... />

    </svg>
    <div class=""minimap-info-overlay""> @* Shows Zoom/Pan info *@ </div>
</div>

@code
{
    // 1. Cascade the service
    [CascadingParameter] 
    private IDiagramService Service { get; set; } = null!;

    // Parameters for size, colors, etc.
    [Parameter] public double Width { get; set; } = 150; 
    [Parameter] public double Height { get; set; } = 100;
    // ... other parameters like NodeColor, LinkColor ...

    // Internal state for SVG viewbox and viewport rectangle
    private double _viewBoxMinX, _viewBoxMinY, _viewBoxWidth, _viewBoxHeight;
    private double _viewportRectX, _viewportRectY, _viewportRectWidth, _viewportRectHeight;

    private List<IDisposable> _subscriptions = new List<IDisposable>();
    
    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 2. Subscribe to ALL relevant events to trigger refresh
            _subscriptions =
            [
                Service.Events.SubscribeTo<NodeAddedEvent>(Refresh),
                Service.Events.SubscribeTo<NodePositionChangedEvent>(Refresh),
                // ... many more subscriptions for node/group/link/port changes ...
                Service.Events.SubscribeTo<DiagramPanChangedEvent>(Refresh),
                Service.Events.SubscribeTo<DiagramZoomChangedEvent>(Refresh),
            ];
            // Initial calculation
            Refresh(null!); 
        }
        return base.OnAfterRenderAsync(firstRender);
    }

    // 3. Refresh calculates bounds, viewport, and viewbox
    private void Refresh(IEvent? e)
    {
        CalculateViewport(); // Calculate main diagram's visible area
        var bounds = Service.GetAllBounds(); // Get bounding box of all elements
        CalculateViewBox(bounds); // Calculate SVG viewbox to fit everything + viewport
        InvokeAsync(StateHasChanged);
    }

    private void CalculateViewport() { /* ... Calculates _viewportRectX/Y/Width/Height ... */ }
    private void CalculateViewBox(DiagramBounds bounds) { /* ... Calculates _viewBoxMinX/Y/Width/Height ... */ }

    public void Dispose() { /* ... Unsubscribe events ... */ }

    private string ViewBoxString => $""{_viewBoxMinX} {_viewBoxMinY} {_viewBoxWidth} {_viewBoxHeight}"";
}
";

}