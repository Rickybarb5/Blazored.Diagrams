@page "/custom-behaviours"
@implements IDisposable

    <MudContainer MaxWidth="MaxWidth.False" Style="height:100%; padding-top: 20px;">
        <MudGrid Style="height:100%">

            <MudItem xs="12" md="6" Style="height:100%;">
                <MudPaper Class="pa-4 mud-height-full d-flex flex-column overflow-y-auto" Elevation="4">
                    <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-4">Custom Behaviors</MudText>

                    <MudText Typo="Typo.subtitle1" Class="mb-3">
                        Behaviors are where the **business logic and interactivity** of the diagram reside. You can create a custom behavior to completely change how the diagram responds to events.
                    </MudText>

                    <MudExpansionPanels MultiExpansion="true">

                        <MudExpansionPanel Text="Step 1: Create the Custom Class" Expanded="true">
                            <MudText Typo="Typo.body1" GutterBottom="true">
                                Inherit from <code class="text-primary">BaseBehaviour</code> and inject <code class="text-primary">IDiagramService</code> to gain access to the <code class="text-primary">Events</code> aggregator.
                            </MudText>
                            <CodeHighlighter Language="csharp" Code="@customBehaviourClassCode"></CodeHighlighter>
                            <MudText Typo="Typo.body1" GutterBottom="true" Class="mt-3">
                                Our example subscribes to <code class="text-primary">DiagramDoubleClickedEvent</code> and, when triggered, selects all models in the diagram.
                            </MudText>
                        </MudExpansionPanel>

                        <MudExpansionPanel Text="Step 2: Registration & Control" Expanded="true">
                            <MudText Typo="Typo.body1" GutterBottom="true">
                                You must register the custom behavior in the <code class="text-primary">OnInitializedAsync</code> method of your component.
                            </MudText>
                            <CodeHighlighter Language="csharp" Code="@registrationCode"></CodeHighlighter>

                            <MudText Typo="Typo.h6" Class="mt-4 mb-2">Live Demo Control</MudText>
                            <MudAlert Severity="Severity.Info" Class="mb-3">
                                Double-click on the **empty background** of the diagram on the right to test this behavior!
                            </MudAlert>

                            <div class="d-flex align-center gap-4">
                                
                                    <MudSwitch @bind-Value="IsBehaviourEnabled"
                                               T="bool"
                                               Color="Color.Primary"
                                               LabelPlacement="Placement.Right"
                                               Label="Double-Tap Select Enabled"
                                               Disabled="@(!_isRegistered)"/>
                                @if (!_isRegistered)
                                {
                                    <MudAlert Severity="Severity.Warning" Dense="true" Class="ml-4">
                                        Behavior not yet registered.
                                    </MudAlert>
                                }
                            </div>
                        </MudExpansionPanel>

                    </MudExpansionPanels>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6" Style="height:100%">
                <MudPaper Class="mud-height-full" Elevation="4">
                    <DiagramContainer DiagramService="Service"></DiagramContainer>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>

@code {
    [Inject] public IDiagramService Service { get; set; } = null!;

    private bool _isRegistered;

    private bool IsBehaviourEnabled
    {
        get => Service.Behaviours.GetBehaviourOptions<DoubleTapSelectOptions>()!.IsEnabled;
        set
        {
            Service.Behaviours.GetBehaviourOptions<DoubleTapSelectOptions>()!.IsEnabled = value;
            StateHasChanged();
        }
    }

    protected override Task OnInitializedAsync()
    {
        // Register the custom behaviour, associating it with the options
        Service.Behaviours.RegisterBehaviourOptions(new DoubleTapSelectOptions());
        Service.Behaviours.RegisterBehaviour(new DoubleTapSelectBehaviour(Service));

        _isRegistered = true;

        // 3. Add demo nodes and links
        var node1 = new Node();
        node1.SetPosition(100, 100);
        Service.Add.Node(node1);
        Service.Add.PortTo(node1, new Port { Alignment = PortAlignment.Right });

        var node2 = new Node();
        node2.SetPosition(400, 300);
        Service.Add.Node(node2);
        Service.Add.PortTo(node2, new Port { Alignment = PortAlignment.Left });

        Service.Add.AddLinkTo(node1.Ports.First(), node2.Ports.First(), new LineLink());

        return base.OnInitializedAsync();
    }

    // --- Code Snippets for Display ---
    private const string customBehaviourClassCode =
        @"public class DoubleTapSelectBehaviour : BaseBehaviour
{
    private readonly IDiagramService _service;

    public DoubleTapSelectBehaviour(IDiagramService service)
    {
        _service = service;
        SubscribeToEvents();
    }

    private void SubscribeToEvents()
    {
        // Subscribe to the event that occurs when the diagram background is double-tapped
        Subscriptions =
        [
            _service.Events.SubscribeTo<DiagramDoubleClickedEvent>(HandleDiagramDoubleClicked)
        ];
    }

    private void HandleDiagramDoubleClicked(DiagramDoubleClickedEvent e)
    {
        // Custom Logic: Select nodes
        e.Model.Nodes.ForEach(n => n.IsSelected = true);

        // Request a full redraw to update the selection visual state immediately
        _service.Events.Publish(new DiagramRedrawEvent(e.Model));
    }

    public void Dispose()
    {
        Subscriptions.DisposeAll();
    }
}";

    private const string registrationCode =
        @"// 1. Define custom options to control the behaviour's state
public class DoubleTapSelectOptions : BehaviourOptionsBase {}

 protected override Task OnInitializedAsync()
    {
        // Register the options and the behaviour.
        Service.Behaviours.RegisterBehaviourOptions(new DoubleTapSelectOptions());
        Service.Behaviours.RegisterBehaviour(new DoubleTapSelectBehaviour(Service));

    return base.OnInitializedAsync();
}";

    public void Dispose()
    {
        // Since we registered a new behaviour, it will automatically be disposed 
        // by the DiagramService when it's used with a new diagram or disposed.
    }

}